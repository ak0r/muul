---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import SEO from "@/components/SEO.astro";
import PostHeader from "@/components/PostHeader.astro";
import SeriesNav from "@/components/SeriesNav.astro";
import { calculateReadingTime, getRelatedPosts } from "@/utils/content.utils";
import { siteConfig } from "@/site.config";

interface Props {
  entry: CollectionEntry<"posts">;
}

const { entry } = Astro.props;
const { title, description, published, tags, cover, series } = entry.data;
const publishedTime = published;

const allPosts = await getCollection("posts", ({ data }) => !data.draft);
const related = getRelatedPosts(entry, allPosts, siteConfig.relatedPosts);
const postReadTime = calculateReadingTime(entry.body ?? "").text;

// Series: collect and sort posts belonging to the same series
const seriesPosts = series
  ? allPosts
      .filter((p) => p.data.series === series)
      .sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0))
  : [];
---

<BaseLayout>
  <SEO
    slot="seo"
    {title}
    description={description ?? ""}
    type="article"
    {publishedTime}
    {tags}
    image={cover}
  />

  <div class="container">
    <article class="article">

      <PostHeader {title} {published} readTime={postReadTime} {tags} />

      {seriesPosts.length > 1 && (
        <SeriesNav current={entry} posts={seriesPosts} />
      )}

      {cover && (
        <figure class="post-cover">
          <img src={cover} alt={title} />
        </figure>
      )}

      <section class="post-content">
        <slot />
      </section>

      {related.length > 0 && (
        <aside class="related-posts">
          <h2>Related</h2>
          <ul>
            {related.map((post) => (
              <li>
                <a href={`/posts/${post.id}`}>{post.data.title}</a>
                <time datetime={post.data.published.toISOString()}>
                  {post.data.published.toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                  })}
                </time>
              </li>
            ))}
          </ul>
        </aside>
      )}

    </article>
  </div>
</BaseLayout>

<style>
  .post-cover {
    margin-bottom: var(--space-8);
    border-radius: var(--radius-medium);
    overflow: hidden;
  }

  .post-cover img {
    width: 100%;
    display: block;
  }

  .post-content {
    margin-bottom: var(--space-10);
  }

  .related-posts {
    border-top: 1px solid var(--border);
    padding-top: var(--space-8);
    margin-top: var(--space-8);
  }

  .related-posts h2 {
    font-size: var(--text-4);
    margin-bottom: var(--space-4);
  }

  .related-posts ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .related-posts li {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: var(--space-4);
  }

  .related-posts a::after {
    content: none !important;
  }

  .related-posts time {
    color: var(--muted-foreground);
    font-size: var(--text-7);
    white-space: nowrap;
    flex-shrink: 0;
  }
</style>