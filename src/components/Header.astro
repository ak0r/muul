---
import { siteConfig } from "@/site.config";

const currentPath = new URL(Astro.request.url).pathname;

function isActive(href: string): boolean {
  if (href === "/") return currentPath === "/";
  return currentPath.startsWith(href);
}
---

<header>
  <div class="container">
    <nav>
      <a href="/" aria-label={`${siteConfig.title} home`} class="brand">{siteConfig.title}</a>

      <!-- Desktop nav -->
      <div class="nav-desktop">
        {siteConfig.navigation.map((item) => (
          <a
            href={item.url}
            class="nav-link"
            aria-current={isActive(item.url) ? "page" : undefined}
          >
            {item.title}
          </a>
        ))}
        <button
          id="theme-toggle"
          class="outline theme-toggle"
          aria-label="Toggle theme"
          title="Toggle light/dark theme"
        >
          <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="4"/>
            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
          </svg>
          <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
          </svg>
        </button>
      </div>

      <!-- Mobile hamburger -->
      <button
        id="nav-toggle"
        class="outline nav-mobile-toggle"
        aria-label="Toggle menu"
        aria-expanded="false"
        aria-controls="nav-mobile"
      >☰</button>
    </nav>
  </div>

  <!-- Mobile dropdown -->
  <div id="nav-mobile" class="nav-mobile" hidden>
    <div class="container">
      {siteConfig.navigation.map((item) => (
        <a
          href={item.url}
          class="nav-link"
          aria-current={isActive(item.url) ? "page" : undefined}
        >
          {item.title}
        </a>
      ))}
      <button
        id="theme-toggle-mobile"
        class="outline theme-toggle"
        aria-label="Toggle theme"
      >
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="4"/>
          <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
        </svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
        </svg>
        <span>Theme</span>
      </button>
    </div>
  </div>
</header>

<script>
  function toggleTheme() {
    var cs = document.documentElement.style.colorScheme;
    var isDark = cs === 'dark' || (!cs && matchMedia('(prefers-color-scheme: dark)').matches);
    var theme = isDark ? 'light' : 'dark';
    document.documentElement.style.colorScheme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
  }

  document.getElementById("theme-toggle")?.addEventListener("click", toggleTheme);
  document.getElementById("theme-toggle-mobile")?.addEventListener("click", toggleTheme);

  const navToggle = document.getElementById("nav-toggle");
  const navMobile = document.getElementById("nav-mobile");

  navToggle?.addEventListener("click", () => {
    const isHidden = navMobile?.hasAttribute("hidden");
    if (isHidden) {
      navMobile?.removeAttribute("hidden");
      navToggle.setAttribute("aria-expanded", "true");
    } else {
      navMobile?.setAttribute("hidden", "");
      navToggle.setAttribute("aria-expanded", "false");
    }
  });
</script>

<style>
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid var(--border);
    background-color: var(--background);
  }

  nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-block: var(--space-3);
    gap: var(--space-4);
  }

  .brand {
    font-family: var(--font-brand);
    font-weight: var(--font-semibold);
    font-size: var(--text-2);
    text-decoration: none;
    color: var(--foreground);
    flex-shrink: 0;

    &:hover {
      color: rgb(from var(--foreground) r g b / 0.8);
    }

    /* No external arrow */
    &::after { content: none !important; }
  }

  .nav-desktop {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .nav-mobile-toggle {
    display: none;
  }

  .nav-mobile {
    border-top: 1px solid var(--border);
  }

  .nav-mobile .container {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    padding-block: var(--space-3);
  }

  /* Icon visibility — moon in light mode, sun in dark mode */
  .icon-sun { display: none; }
  .icon-moon { display: block; }

  :global([data-theme="dark"]) .icon-sun  { display: block; }
  :global([data-theme="dark"]) .icon-moon { display: none;  }

  @media (prefers-color-scheme: dark) {
    .icon-sun  { display: block; }
    .icon-moon { display: none;  }

    :global([data-theme="light"]) .icon-sun  { display: none;  }
    :global([data-theme="light"]) .icon-moon { display: block; }
  }

  @media (max-width: 640px) {
    .nav-desktop    { display: none; }
    .nav-mobile-toggle { display: inline-flex; }
  }
</style>