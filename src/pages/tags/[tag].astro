---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import SEO from "@/components/SEO.astro";
import { groupByYear } from "@/utils/content.utils";

export async function getStaticPaths() {
  const allPosts = await getCollection("posts", ({ data }) => !data.draft);
  const tags = new Set(allPosts.flatMap((post) => post.data.tags ?? []));

  return [...tags].map((tag) => ({
    params: { tag },
    props: {
      posts: allPosts
        .filter((post) => post.data.tags?.includes(tag))
        .sort((a, b) => b.data.published.valueOf() - a.data.published.valueOf()),
    },
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
const grouped = groupByYear(posts);
const postCount = posts.length;
---

<BaseLayout>
  <SEO slot="seo" title={`${tag}`} description={`${postCount} post${postCount === 1 ? '' : 's'} tagged with ${tag}`} />

  <div class="container">
    <header class="tag-header">
      <h1>Posts tagged with #{tag}</h1>
      <p class="tag-meta">{postCount} post{postCount === 1 ? '' : 's'}</p>
    </header>

    {[...grouped.entries()].map(([year, posts]) => (
      <div class="year-group">
        <h2 class="year-heading">{year}</h2>
        <ul class="post-list">
          {posts.map((post) => (
            <li class="post-item">
              <a href={`/posts/${post.id}`}>{post.data.title}</a>
              <time datetime={post.data.published.toISOString()}>
                {post.data.published.toLocaleDateString("en-US", { month: "short", day: "numeric" })}
              </time>
            </li>
          ))}
        </ul>
      </div>
    ))}
  </div>
</BaseLayout>

<style>
  .tag-header {
    margin-bottom: var(--space-10);
    padding-bottom: var(--space-6);
    border-bottom: 1px solid var(--border);
  }

  .tag-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted-foreground);
    margin-bottom: var(--space-2);
  }

  .tag-header h1 {
    margin-bottom: var(--space-2);
  }

  .tag-meta {
    color: var(--muted-foreground);
    font-size: 0.9rem;
    margin: 0;
  }

  .year-group {
    margin-bottom: var(--space-8);
  }

  .year-heading {
    color: var(--muted-foreground);
    margin-bottom: var(--space-3);
  }

  .post-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .post-item {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: var(--space-4);
  }

  .post-item time {
    color: var(--muted-foreground);
    font-size: 0.85rem;
    white-space: nowrap;
  }
</style>